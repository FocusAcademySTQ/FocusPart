<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <title>Admin - Gesti√≥ Classes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{min-height:100px;background:white;border-radius:6px;padding:6px;box-shadow:0 1px 3px rgba(0,0,0,0.1);font-size:13px;transition:0.2s}
    .day:hover{background:#f0f9ff}
    .class{background:#dbeafe;border-radius:4px;padding:2px 4px;margin-top:4px;font-size:12px;display:flex;justify-content:space-between;align-items:center}
    .btn{padding:2px 6px;border-radius:4px;font-size:12px}
  </style>
</head>
<body class="bg-gray-50 p-6 font-sans">
  <h1 class="text-2xl font-bold mb-4">üìò Panell Administrador</h1>
  <section class="mb-8 p-4 bg-white rounded shadow">
    <h2 class="text-lg font-semibold mb-3">‚ûï Afegir nova classe</h2>
    <form id="newClassForm" class="grid grid-cols-4 gap-2">
      <input type="text" id="alumne" placeholder="Nom de l'alumne" class="border p-2 rounded col-span-1" required>
      <select id="profeSelect" class="border p-2 rounded col-span-1" required></select>
      <input type="date" id="data" class="border p-2 rounded col-span-1" required>
      <input type="time" id="hora" class="border p-2 rounded col-span-1" required>
      <div class="col-span-4 flex flex-wrap gap-2">
        <label><input type="checkbox" value="1" class="dayCheck"> Dilluns</label>
        <label><input type="checkbox" value="2" class="dayCheck"> Dimarts</label>
        <label><input type="checkbox" value="3" class="dayCheck"> Dimecres</label>
        <label><input type="checkbox" value="4" class="dayCheck"> Dijous</label>
        <label><input type="checkbox" value="5" class="dayCheck"> Divendres</label>
        <label><input type="checkbox" value="6" class="dayCheck"> Dissabte</label>
        <label><input type="checkbox" value="0" class="dayCheck"> Diumenge</label>
      </div>
      <input type="number" id="preu" placeholder="‚Ç¨" class="border p-2 rounded col-span-1" required>
      <button class="col-span-4 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded">Afegir classe</button>
    </form>
  </section>
  <section class="p-4 bg-white rounded shadow">
    <h2 class="text-lg font-semibold mb-3">üóìÔ∏è Vista mensual</h2>
    <div class="flex items-center gap-2 mb-4">
      <button id="prevMonth" class="px-2 py-1 bg-gray-200 rounded">‚¨ÖÔ∏è</button>
      <span id="monthLabel" class="font-semibold"></span>
      <button id="nextMonth" class="px-2 py-1 bg-gray-200 rounded">‚û°Ô∏è</button>
    </div>
    <div class="calendar" id="calendar"></div>
  </section>
  <section class="p-4 bg-white rounded shadow mt-6">
    <h2 class="text-lg font-semibold mb-3">üí∂ Resum d‚Äôingressos</h2>
    <table class="w-full text-sm border">
      <thead>
        <tr class="bg-gray-100">
          <th class="border p-2">Professor</th>
          <th class="border p-2">Classes</th>
          <th class="border p-2">‚Ç¨ per classe</th>
          <th class="border p-2">Total</th>
        </tr>
      </thead>
      <tbody id="resumTaula"></tbody>
    </table>
    <p class="font-bold mt-3">Total global: <span id="totalGlobal">0</span> ‚Ç¨</p>
  </section>
  <script>
    const user=JSON.parse(localStorage.getItem("admin"));
    if(!user||user.role!=="admin"){window.location.href="index.html"}
    let currentMonth=new Date();
    async function loadProfessors(){
      const res=await fetch("/api/professors");
      const profes=await res.json();
      document.getElementById("profeSelect").innerHTML="<option value=''>-- Tria profe --</option>"+profes.map(p=>`<option value="${p.nom}">${p.nom}</option>`).join("");
      return profes;
    }
    document.getElementById("newClassForm").addEventListener("submit",async e=>{
      e.preventDefault();
      const alumne=document.getElementById("alumne").value;
      const profe=document.getElementById("profeSelect").value;
      const data=document.getElementById("data").value;
      const hora=document.getElementById("hora").value;
      const preu=parseFloat(document.getElementById("preu").value);
      await fetch("/api/classes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({alumne,profe,data,hora,preu})});
      const checks=document.querySelectorAll(".dayCheck:checked");
      if(checks.length>0){
        let start=new Date(data);
        let end=new Date();end.setMonth(end.getMonth()+3);
        let current=new Date(start);current.setDate(current.getDate()+1);
        while(current<=end){
          if([...checks].map(c=>c.value).includes(current.getDay().toString())){
            await fetch("/api/classes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({alumne,profe,data:current.toISOString().split("T")[0],hora,preu})});
          }
          current.setDate(current.getDate()+1);
        }
      }
      e.target.reset();
      loadCalendar();
    });
    function getMonthDays(year,month){
      const lastDay=new Date(year,month+1,0);
      let days=[];for(let d=1;d<=lastDay.getDate();d++){days.push(new Date(year,month,d))}return days;
    }
    async function loadCalendar(){
      const year=currentMonth.getFullYear();
      const month=currentMonth.getMonth();
      const label=currentMonth.toLocaleString("ca-ES",{month:"long",year:"numeric"});
      document.getElementById("monthLabel").textContent=label;
      const res=await fetch(`/api/classes?month=${year}-${String(month+1).padStart(2,"0")}`);
      const classes=await res.json();
      const profes=await loadProfessors();
      const days=getMonthDays(year,month);
      const cal=document.getElementById("calendar");
      cal.innerHTML="";
      let startDay=(new Date(year,month,1).getDay()+6)%7;
      for(let i=0;i<startDay;i++){cal.innerHTML+="<div></div>"}
      days.forEach(d=>{
        const iso=d.toISOString().split("T")[0];
        const dayClasses=classes.filter(c=>c.data===iso&&!c.cancelled);
        let html=`<div class="day"><div class="font-bold mb-1">${d.getDate()}</div>`;
        dayClasses.forEach(c=>{html+=`<div class="class"><span>${c.hora} - ${c.alumne} (${c.profe})</span></div>`});
        html+="</div>";
        cal.innerHTML+=html;
      });
      const perProfe={};let total=0;
      classes.filter(c=>!c.cancelled).forEach(c=>{
        const prof=profes.find(p=>p.nom===c.profe);
        if(prof){
          perProfe[c.profe]=perProfe[c.profe]||{count:0,valoracio:prof.valoracio,total:0};
          perProfe[c.profe].count++;
          perProfe[c.profe].total+=prof.valoracio;
          total+=prof.valoracio;
        }
      });
      document.getElementById("resumTaula").innerHTML=Object.entries(perProfe).map(([p,d])=>`
        <tr>
          <td class="border p-2">${p}</td>
          <td class="border p-2">${d.count}</td>
          <td class="border p-2">${d.valoracio} ‚Ç¨</td>
          <td class="border p-2 font-bold">${d.total} ‚Ç¨</td>
        </tr>`).join("");
      document.getElementById("totalGlobal").textContent=total;
    }
    document.getElementById("prevMonth").addEventListener("click",()=>{currentMonth.setMonth(currentMonth.getMonth()-1);loadCalendar()});
    document.getElementById("nextMonth").addEventListener("click",()=>{currentMonth.setMonth(currentMonth.getMonth()+1);loadCalendar()});
    loadCalendar();
  </script>
</body>
</html>
