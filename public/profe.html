<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <title>Profe - Gesti√≥ Classes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{min-height:100px;background:white;border-radius:8px;padding:6px;box-shadow:0 1px 3px rgba(0,0,0,0.1);font-size:13px;transition:0.2s}
    .day:hover{background:#f0f9ff}
    .class{background:#dbeafe;border-radius:4px;padding:2px 4px;margin-top:4px;font-size:12px;display:flex;justify-content:space-between;align-items:center}
    .btn{padding:2px 6px;border-radius:4px;font-size:12px}
  </style>
</head>
<body class="bg-gray-50 p-6 font-sans">
  <h1 class="text-2xl font-bold mb-4">üë®‚Äçüè´ Panell Professor</h1>
  <p id="welcome" class="mb-6"></p>

  <!-- Nova classe -->
  <section class="mb-8 p-4 bg-white rounded shadow">
    <h2 class="text-lg font-semibold mb-3">‚ûï Afegir nova classe</h2>
    <form id="newClassForm" class="grid grid-cols-4 gap-2">
      <input type="text" id="alumne" placeholder="Nom de l'alumne" class="border p-2 rounded col-span-1" required>
      <input type="date" id="data" class="border p-2 rounded col-span-1" required>
      <input type="time" id="hora" class="border p-2 rounded col-span-1" required>
      <select id="repeticio" class="border p-2 rounded col-span-1">
        <option value="0">No repetir</option>
        <option value="1">Repetir 1 setmana</option>
        <option value="2">Repetir 2 setmanes</option>
      </select>
      <button class="col-span-4 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded">Afegir classe</button>
    </form>
  </section>

  <!-- Vista mensual -->
  <section class="p-4 bg-white rounded shadow">
    <h2 class="text-lg font-semibold mb-3">üóìÔ∏è Les meves classes (vista mensual)</h2>
    <div class="flex items-center gap-2 mb-4">
      <button id="prevMonth" class="px-2 py-1 bg-gray-200 rounded">‚¨ÖÔ∏è</button>
      <span id="monthLabel" class="font-semibold"></span>
      <button id="nextMonth" class="px-2 py-1 bg-gray-200 rounded">‚û°Ô∏è</button>
    </div>
    <div class="calendar" id="calendar"></div>
  </section>

  <script>
    const profe=JSON.parse(localStorage.getItem("profe"));
    if(!profe) window.location.href="index.html";
    document.getElementById("welcome").textContent="Benvingut/da, "+profe.nom;
    let currentMonth=new Date();

    // üîπ Crear classe amb repetici√≥
    document.getElementById("newClassForm").addEventListener("submit",async e=>{
      e.preventDefault();
      const alumne=document.getElementById("alumne").value;
      const data=document.getElementById("data").value;
      const hora=document.getElementById("hora").value;
      const repeticio=parseInt(document.getElementById("repeticio").value);

      let dates=[new Date(data)];
      for(let i=1;i<=repeticio;i++){
        let d=new Date(data);
        d.setDate(d.getDate()+7*i);
        dates.push(d);
      }

      for(const d of dates){
        await fetch("/api/classes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({
          alumne,
          profe:profe.nom,
          data:d.toISOString().split("T")[0],
          hora
        })});
      }

      e.target.reset();
      loadCalendar();
    });

    // üîπ Carregar classes
    async function loadCalendar(){
      const year=currentMonth.getFullYear();
      const month=currentMonth.getMonth();
      const label=currentMonth.toLocaleString("ca-ES",{month:"long",year:"numeric"});
      document.getElementById("monthLabel").textContent=label;

      const res=await fetch("/api/classes");
      let classes=await res.json();
      classes=classes.filter(c=>c.profe===profe.nom && !c.cancelled);

      const days=getMonthDays(year,month);
      const cal=document.getElementById("calendar");
      cal.innerHTML="";
      let startDay=(new Date(year,month,1).getDay()+6)%7;
      for(let i=0;i<startDay;i++){cal.innerHTML+="<div></div>"}
      days.forEach(d=>{
        const iso=d.toISOString().split("T")[0];
        const dayClasses=classes.filter(c=>c.data===iso);
        let html=`<div class="day"><div class="font-bold mb-1">${d.getDate()}</div>`;
        dayClasses.forEach(c=>{
          html+=`
            <div class="class">
              <span>${c.hora} - ${c.alumne}</span>
              <div>
                <button class="btn bg-green-200 hover:bg-green-300" onclick="toggleDone('${c._id}')">‚úîÔ∏è</button>
                <button class="btn bg-red-200 hover:bg-red-300" onclick="toggleCancel('${c._id}')">‚ùå</button>
              </div>
            </div>`;
        });
        html+="</div>";
        cal.innerHTML+=html;
      });
    }

    function getMonthDays(year,month){
      const lastDay=new Date(year,month+1,0);
      let days=[];for(let d=1;d<=lastDay.getDate();d++){days.push(new Date(year,month,d))}return days;
    }

    async function toggleDone(id){
      await fetch(`/api/classes/${id}/toggle`,{method:"PUT"});
      loadCalendar();
    }
    async function toggleCancel(id){
      await fetch(`/api/classes/${id}/cancel`,{method:"PUT"});
      loadCalendar();
    }

    document.getElementById("prevMonth").addEventListener("click",()=>{currentMonth.setMonth(currentMonth.getMonth()-1);loadCalendar()});
    document.getElementById("nextMonth").addEventListener("click",()=>{currentMonth.setMonth(currentMonth.getMonth()+1);loadCalendar()});

    loadCalendar();
  </script>
</body>
</html>
